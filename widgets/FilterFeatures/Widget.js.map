{"version":3,"sources":["../../../widgets/FilterFeatures/Widget.js"],"names":["declare","BaseWidget","_WidgetsInTemplateMixin","Query","QueryTask","dom","on","lang","LayerInfos","Dialog","genFunction","registry","baseClass","gf","postCreate","inherited","arguments","console","log","self","startup","_idDepa","config","departamento","id","_fieldCodDepa","value","_fieldNomDepa","label","clause","_clauseTransversal","_idProv","provincia","_fieldCodProv","_fieldNomProv","_idDist","distrito","_fieldCodDist","_fieldNomDist","_layerInfosObjClone","_codFilter","getInstance","map","itemInfo","then","hitch","layerInfosObj","infos","getLayerInfoArray","_turnLayers","_filterOptions","depaSelectAttachPoint","_filterFeatureDepa","evt","_zoomExtendSelected","provSelectAttachPoint","_filterFeatureProv","distSelectAttachPoint","_filterFeatureDist","idService","valueField","labelField","dojonodeAlias","feature","getLayerInfoById","urlService","getUrl","options","queryTask","query","where","outFields","execute","results","i","features","opt","attributes","push","_sortArray","set","field","setFilter","show","_setMapExtent","executeForExtent","response","extent","setExtent","_filterFeatures","spinner","document","getElementsByClassName","style","visibility","errorDialog","title","content","url","idFeature","_setClauseTraversal","_toggleEnabledForm","toggle","buttonFiltrarff","_newFilter","_addFilter"],"mappings":"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","file":"Widget.js","sourcesContent":["import declare from 'dojo/_base/declare';\r\nimport BaseWidget from 'jimu/BaseWidget';\r\nimport _WidgetsInTemplateMixin from 'dijit/_WidgetsInTemplateMixin';\r\nimport Query from \"esri/tasks/query\";\r\nimport QueryTask from \"esri/tasks/QueryTask\";\r\nimport dom from \"dojo/dom\";\r\nimport on from \"dojo/on\";\r\nimport lang from 'dojo/_base/lang';\r\nimport LayerInfos from 'jimu/LayerInfos/LayerInfos';\r\nimport Dialog from \"dijit/Dialog\";\r\nimport genFunction from \"./GenFunctions\"\r\nimport registry from \"dijit/registry\";\r\n\r\n// To create a widget, you need to derive from BaseWidget.\r\nexport default declare([\r\n  BaseWidget, \r\n  _WidgetsInTemplateMixin, \r\n  Query, \r\n  QueryTask], {\r\n\r\n  // Custom widget code goes here\r\n\r\n  baseClass: 'filter-features',\r\n  gf: genFunction(),\r\n\r\n  // add additional properties here\r\n\r\n  // methods to communication with app container:\r\n  postCreate () {\r\n    this.inherited(arguments);\r\n    console.log('FilterFeatures::postCreate');\r\n    self = this;\r\n  },\r\n  \r\n  startup() {\r\n    this.inherited(arguments);\r\n\r\n    _idDepa = this.config.departamento.id;\r\n    _fieldCodDepa = this.config.departamento.value;\r\n    _fieldNomDepa = this.config.departamento.label;\r\n    clause = \"1=1\"\r\n    _clauseTransversal = \"\";\r\n\r\n    _idProv = this.config.provincia.id;\r\n    _fieldCodProv = this.config.provincia.value;\r\n    _fieldNomProv = this.config.provincia.label;\r\n\r\n    _idDist = this.config.distrito.id;\r\n    _fieldCodDist = this.config.distrito.value;\r\n    _fieldNomDist = this.config.distrito.label;\r\n\r\n    _layerInfosObjClone = []\r\n    _codFilter = null;\r\n\r\n    LayerInfos.getInstance(this.map, this.map.itemInfo)\r\n    .then(lang.hitch(this, function(layerInfosObj) {\r\n        _layerInfosObjClone = layerInfosObj;\r\n        var infos = layerInfosObj.getLayerInfoArray();\r\n        this.gf._turnLayers(infos, false);\r\n      })\r\n    );\r\n\r\n    this._filterOptions(_idDepa, null, clause, _fieldCodDepa, _fieldNomDepa, self.depaSelectAttachPoint);\r\n  },\r\n\r\n  _filterFeatureDepa(evt){\r\n    var clause = `${_fieldCodProv} like '${evt}%'`\r\n\r\n    this._zoomExtendSelected(_idDepa, _fieldCodDepa, evt);\r\n    this._filterOptions(_idProv, evt, clause, _fieldCodProv, _fieldNomProv, self.provSelectAttachPoint);\r\n  },\r\n\r\n  _filterFeatureProv(evt){\r\n    var clause = `${_fieldCodDist} like '${evt}%'`\r\n\r\n    this._zoomExtendSelected(_idProv, _fieldCodProv, evt);\r\n    this._filterOptions(_idDist, evt, clause, _fieldCodDist, _fieldNomDist, self.distSelectAttachPoint);\r\n  },\r\n\r\n  _filterFeatureDist(evt){\r\n    _codFilter = evt;\r\n    this._zoomExtendSelected(_idDist, _fieldCodDist, _codFilter);\r\n  },\r\n\r\n  _filterOptions(idService, value, clause, valueField, labelField, dojonodeAlias){\r\n    _codFilter = value;\r\n    var feature = _layerInfosObjClone.getLayerInfoById(idService);\r\n    urlService = feature.getUrl();\r\n\r\n    var options = []\r\n    var queryTask = new QueryTask(urlService);\r\n    var query = new Query();\r\n    query.where = clause;\r\n    query.outFields = [valueField, labelField];\r\n    queryTask.execute(query, function(results){\r\n      for(var i in results.features){\r\n        var opt = {\r\n          label: results.features[i].attributes[labelField],\r\n          value: results.features[i].attributes[valueField]\r\n        };\r\n        options.push(opt);\r\n      }\r\n      options = self.gf._sortArray(options, 'label')\r\n      dojonodeAlias.set('options', options);\r\n    });\r\n  },\r\n\r\n  _zoomExtendSelected(idService, field, value){\r\n\r\n    var clause = `${field}='${value}'`;\r\n\r\n    var feature = _layerInfosObjClone.getLayerInfoById(idService);\r\n    urlService = feature.getUrl();\r\n    feature.setFilter(clause);\r\n    feature.show();\r\n    this._setMapExtent(urlService, clause);\r\n  },\r\n\r\n  _setMapExtent(urlService, clause){\r\n      var queryTask = new QueryTask(urlService);\r\n      var query = new Query();\r\n      query.where = clause;\r\n      queryTask.executeForExtent(query, function(response){\r\n        var extent = response.extent;\r\n        self.map.setExtent(extent, true);        \r\n    })\r\n  },\r\n\r\n  _filterFeatures(evt){\r\n    var spinner = document.getElementsByClassName(\"loaderff\")[0];\r\n    spinner.style.visibility = \"visible\"\r\n    if (_codFilter == null){\r\n      errorDialog = new Dialog({\r\n        title: \"Error\",\r\n        content: \"No ha seleccionado el ámbito de búsqueda!\",\r\n      });\r\n      errorDialog.show()\r\n      return;\r\n    }\r\n    var url;\r\n    var field;\r\n    var clause;\r\n    var queryTask;\r\n    var query;\r\n    var features = this.config.features;\r\n    for (var i in features){\r\n\r\n      idFeature = features[i].id;\r\n\r\n      var feature = _layerInfosObjClone.getLayerInfoById(idFeature);\r\n      field = features[i].field;\r\n      clause = this._setClauseTraversal(`${field} like '${_codFilter}%'`);\r\n      feature.setFilter(clause);\r\n      feature.show();   \r\n    }\r\n    this._toggleEnabledForm(true);\r\n    spinner.style.visibility = \"hidden\"\r\n  },\r\n\r\n  _toggleEnabledForm(toggle){\r\n    this.buttonFiltrarff.set('disabled', toggle);\r\n    this.depaSelectAttachPoint.set(\"disabled\", toggle)\r\n    this.provSelectAttachPoint.set(\"disabled\", toggle)\r\n    this.distSelectAttachPoint.set(\"disabled\", toggle)\r\n  },\r\n\r\n  _newFilter(){\r\n     this._toggleEnabledForm(false);\r\n     _clauseTransversal = ''\r\n  },\r\n\r\n  _addFilter(){\r\n    this._toggleEnabledForm(false);\r\n  },\r\n\r\n  _setClauseTraversal(clause){\r\n    _clauseTransversal = (_clauseTransversal) ? _clauseTransversal + ' or ' + clause : clause;\r\n    return _clauseTransversal;\r\n  }\r\n\r\n  // onOpen() {\r\n  //   console.log('FilterFeatures::onOpen');\r\n  // },\r\n  // onClose(){\r\n  //   console.log('FilterFeatures::onClose');\r\n  // },\r\n  // onMinimize(){\r\n  //   console.log('FilterFeatures::onMinimize');\r\n  // },\r\n  // onMaximize(){\r\n  //   console.log('FilterFeatures::onMaximize');\r\n  // },\r\n  // onSignIn(credential){\r\n  //   console.log('FilterFeatures::onSignIn', credential);\r\n  // },\r\n  // onSignOut(){\r\n  //   console.log('FilterFeatures::onSignOut');\r\n  // }\r\n  // onPositionChange(){\r\n  //   console.log('FilterFeatures::onPositionChange');\r\n  // },\r\n  // resize(){\r\n  //   console.log('FilterFeatures::resize');\r\n  // }\r\n});\r\n"]}